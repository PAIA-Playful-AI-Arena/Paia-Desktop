<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>PAIA Desktop</title>
    <link rel="stylesheet" href="node_modules/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script>window.jQuery = window.$ = require('jquery');</script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.js"></script>
    <script src="renderer.js"></script>
  </head>
  <body>
    <!-- Login dialog -->
    <div class="modal fade" id="login-dialog" tabindex="-1" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <h5 class="text-center mt-3">登入 PAIA</h5>
          <form name="play" action="javascript:login()">
            <div class="modal-body my-2">
              <div class="container">
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" class="form-control" id="email" aria-describedby="emailHelp" placeholder="account@gmail.com" required>
                </div>
                <div class="form-group">
                  <label for="password">密碼</label>
                  <input type="password" class="form-control" id="password" placeholder="Password" required>
                </div>
                <button type="submit" class="btn btn-primary">登入</button>
                <span class="text-danger ml-3" id="state-content"></span>
              </div>
            </div>
          </form>
          <button type="button" onclick="google_login()">
            <img src="media/google-login.png" alt="...">
          </button>
        </div>
      </div>
    </div>
    <!-- Game list -->
    <div class="card m-3 mx-auto">
      <div class="row g-0">
        <div class="col-md-4">
          <img src="media/easygame.svg" alt="...">
        </div>
        <div class="col-md-8">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted float-right"><span class="verison" game='easy_game'>...</span></h6>
            <h3 class="card-title">Easy Game (教學)</h3>
            <p class="card-text">一個讓你熟習所有基本操作的小遊戲。</p>
            <a href="code.html?game=easy_game" class="btn btn-primary">積木</a>
            <a href="python.html?game=easy_game" class="btn btn-primary">Python</a>
          </div>
        </div>
      </div>
    </div>
    <div class="card m-3 mx-auto">
      <div class="row g-0">
        <div class="col-md-4">
          <img src="media/arkanoid.svg" alt="...">
        </div>
        <div class="col-md-8">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted float-right"><span class="verison" game='arkanoid'>...</span></h6>
            <h3 class="card-title">打磚塊</h3>
            <p class="card-text">打磚塊(Arkanoid)可是世界上最古老經典遊戲之一，透過決定發球的位置與方向，嘗試接到回彈的球，逐一打掉所有磚塊。來挑戰看看如何在最短時間內擊破所有的磚塊，遊戲中還準備了各種不同的難度來讓你挑戰喔！</p>
            <a href="code.html?game=arkanoid" class="btn btn-primary arkanoid">積木</a>
            <a href="python.html?game=arkanoid" class="btn btn-primary arkanoid">Python</a>
            <a onclick="git_download('direct:https://github.com/PAIA-Playful-AI-Arena/arkanoid/archive/refs/heads/main.zip', 'MLGame/games/arkanoid', this)" class="btn btn-primary float-right"><i class="bi bi-download"></i> 下載 / 更新</a>
          </div>
        </div>
      </div>
    </div>
    <div class="card mb-3 mx-auto" style="width: calc(100vw - (40px));">
      <div class="row g-0">
        <div class="col-md-4">
          <img src="media/pingpong.svg" alt="...">
        </div>
        <div class="col-md-8">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted float-right"><span class="verison" game='pingpong'>...</span></h6>
            <h3 class="card-title">乒乓球</h3>
            <p class="card-text">想要體驗一場有趣且刺激的乒乓球遊戲嗎？操控發球及反擊的時機讓對手無路可逃，喜歡快節奏的你一定要來體驗看看！遊戲中也有不同難度的對手，歡迎各位來挑戰它們。</p>
            <a href="code.html?game=pingpong" class="btn btn-primary pingpong">積木</a>
            <a href="python.html?game=pingpong" class="btn btn-primary pingpong">Python</a>
            <a onclick="git_download('direct:https://github.com/PAIA-Playful-AI-Arena/pingpong/archive/refs/heads/main.zip', 'MLGame/games/pingpong', this)" class="btn btn-primary float-right"><i class="bi bi-download"></i> 下載 / 更新</a>
          </div>
        </div>
      </div>
    </div>
    <div class="card mb-3 mx-auto" style="width: calc(100vw - (40px));">
      <div class="row g-0">
        <div class="col-md-4">
          <img src="media/racingcar.svg" alt="...">
        </div>
        <div class="col-md-8">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted float-right"><span class="verison" game='RacingCar'>...</span></h6>
            <h3 class="card-title">賽車</h3>
            <p class="card-text">來一場競速的排位賽吧！駕駛著自己的車子享受在馬路上狂飆的快感吧！注意前方與左右來車來妨礙你，閃避其他車子的步步逼近，同時還要小心速度太慢被遠遠甩在後頭喔！關卡還有金幣競爭模式，在競速之餘盡可能的去搶奪路上散落的金幣，衝向終點成為最終贏家。</p>
            <a href="code.html?game=RacingCar" class="btn btn-primary RacingCar">積木</a>
            <a href="python.html?game=RacingCar" class="btn btn-primary RacingCar">Python</a>
            <a onclick="git_download('direct:https://github.com/yen900611/RacingCar/archive/refs/heads/master.zip', 'MLGame/games/RacingCar', this)" class="btn btn-primary float-right"><i class="bi bi-download"></i> 下載 / 更新</a>
          </div>
        </div>
      </div>
    </div>
    <div class="card mb-3 mx-auto" style="width: calc(100vw - (40px));">
      <div class="row g-0">
        <div class="col-md-4">
          <img src="media/maze_car.svg" alt="...">
        </div>
        <div class="col-md-8">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted float-right"><span class="verison" game='Maze_Car'>...</span></h6>
            <h3 class="card-title">迷宮自走車</h3>
            <p class="card-text">在錯綜復雜的棋盤迷宮中，如何讓你的自走車突破重圍，走到出口，而不會迷失在其之中。本遊戲也提供多元的關卡，隨著遊戲難度提升，迷宮的牆壁可是會移動，考驗各位玩家如何再多變的環境下，依然能夠逃出迷宮。</p>
            <a href="code.html?game=Maze_Car" class="btn btn-primary Maze_Car">積木</a>
            <a href="python.html?game=Maze_Car" class="btn btn-primary Maze_Car">Python</a>
            <a onclick="git_download('direct:https://github.com/yen900611/Maze_Car/archive/refs/heads/master.zip', 'MLGame/games/Maze_Car', this)" class="btn btn-primary float-right"><i class="bi bi-download"></i> 下載 / 更新</a>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  function token_login() {
    console.log(window.getAccessToken(), window.getRefreshToken())
    if (window.getAccessToken() == "no token") {
      $('#login-dialog').modal('show');
      return;
    } else {
      window.paiaAPI("GET", "auth/token/verify", null, false, (res) => {
        return;
        }, (jqXHR, exception) => {
          if (jqXHR.status == 401) {
            // Refresh
            window.paiaAPI("POST", "auth/token/refresh", null, false, {
                refresh: window.getRefreshToken()
              }, (res) => {
                window.setToken(res.access, window.getRefreshToken());
              }, (jqXHR, exception) => {
                window.clearToken();
                $('#state-content').html("登入逾期，請重新登入");
                $('#login-dialog').modal('show');
              }
            );
          } else {
            window.clearToken();
            $('#state-content').html("登入逾期，請重新登入");
            $('#login-dialog').modal('show');
          }
        }
      );
    };
  };
  function login() {
    var email = $('#email').val();
    var password = $('#password').val();
    var data = {
      "type": "general",
      "account": {
        "username": email,
        "password": password
      }
    };
    window.paiaAPI("POST", "auth/token", data, false, (res) => {
        window.setToken(res.access, res.refresh);
        $('#state-content').html('登入成功');
        $('#login-dialog').modal('hide');
      }, (jqXHR, exception) => {
        var msg = '';
        if (jqXHR.status === 0) {
            msg = '連線錯誤，請確認網路';
        } else if (jqXHR.status == 401) {
            msg = '密碼驗證錯誤 [401]';
        } else if (exception === 'abort') {
            msg = 'Ajax request aborted.';
        } else {
            msg = 'Uncaught Error.\n' + jqXHR.responseText;
        }
        $('#state-content').html(msg);
      }
    );
  }
  function google_login() {
    $('#state-content').html('請於瀏覽器登入，成功後會自動返回');
    try {
      myApiOauth.openAuthWindowAndGetTokens()
        .then(token => {
          window.setToken(token);
          var oauth2 = window.getOauth2();
          oauth2.userinfo.get(
            function(err, res) {
              if (err) {
                $('#state-content').html('登入失敗，請確認網路連線後重新登入');
                console.log(err);
              } else {
                $('#state-content').html('登入成功');
                $('#login-dialog').modal('hide');
              }
          });
        });
    } catch(e) {
      console.log(e);
    }
  };
  function update_version_name() {
    Array.from(document.getElementsByClassName('verison')).forEach(e => {
      var fs = require('fs');
      var config_path = path.join(__dirname, 'MLGame', 'games', e.getAttribute('game'), 'game_config.json');
      if (fs.existsSync(config_path)) {
        var config = JSON.parse(window.readFile(config_path));
        e.innerHTML = config['game_name'] + '-' + config['version'];
        if (e.classList.contains('text-danger')) {
          e.classList.remove("text-danger");
        }
        e.classList.add("text-muted");
      } else {
        e.innerHTML = 'Not Found';
        if (e.classList.contains('text-muted')) {
          e.classList.remove("text-muted");
        }
        e.classList.add("text-danger");
        document.querySelectorAll('a.'+ e.getAttribute('game')).forEach(btn => {
          btn.classList.add("disabled");
        });
      }
    });
  };
  function git_download(url, destination, button) {
    if (window.confirm('下載前會清除此遊戲資料夾下的所有檔案，確定執行？')) {
      button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 下載 / 更新';
      document.querySelectorAll('a.btn').forEach(e => {
        e.classList.add("disabled");
      });
      var path = require('path');
      var fs = require('fs');
      destination = path.join(__dirname, destination);
      fs.rmdirSync(destination, { recursive: true });
      var download = require('download-git-repo');
      download(url, destination, function (err) {
        button.innerHTML = '<i class="bi bi-download"></i> 下載 / 更新';
        document.querySelectorAll('a.btn').forEach(e => {
          e.classList.remove("disabled");
        });
        if (err) {
          window.alert(err);
        } else {
          var config = JSON.parse(window.readFile(path.join(destination, 'game_config.json')));
          window.alert(config['game_name'] + '-' + config['version'] + ' 下載成功');
        }
      });
    };
  };
  document.title += ` ${app.getVersion()}`; 
  update_version_name();
  // token_login();
</script>