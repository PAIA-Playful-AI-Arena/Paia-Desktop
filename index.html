<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>PAIA Desktop</title>
    <link rel="stylesheet" href="node_modules/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script>window.jQuery = window.$ = require('jquery');</script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.js"></script>
    <script src="renderer.js"></script>
  </head>
  <body>
    <!-- Login dialog -->
    <div class="modal fade" id="login-dialog" tabindex="-1" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <h5 class="text-center mt-3">登入 PAIA</h5>
          <form name="play" action="javascript:login()">
            <div class="modal-body my-2">
              <div class="container">
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" class="form-control" id="email" aria-describedby="emailHelp" placeholder="account@gmail.com" required>
                </div>
                <div class="form-group">
                  <label for="password">密碼</label>
                  <input type="password" class="form-control" id="password" placeholder="Password" required>
                </div>
                <button type="submit" class="btn btn-primary">登入</button>
                <span class="text-danger ml-3" id="state-content"></span>
              </div>
            </div>
          </form>
          <button type="button" onclick="google_login()">
            <img src="media/google-login.png" alt="...">
          </button>
        </div>
      </div>
    </div>
    <!-- Game list -->
    <div id="game_list"></div>
    <div class="card m-3 mx-auto">
      <div class="card-body">
        <h3 class="card-title">加入新遊戲</h3>
        <button class="btn btn-primary" onclick="window.openPath(path.join(__dirname, 'MLGame', 'games').replace('app.asar', 'app.asar.unpacked'));">開啟遊戲位置</button>
        <!-- <form name="add-game" action="javascript:download_game()">
          <div class="form-group py-1">
            <div class="input-group input-group-sm">
              <div class="input-group-prepend">
                <button type="submit" class="btn btn-primary">下載</button>
              </div>
              <input type="text" class="form-control" id="game_url" placeholder="遊戲 Github 網址" required>
            </div>
          </div>
        </form> -->
      </div>
    </div>
  </body>
</html>

<script>
  function token_login() {
    console.log(window.getAccessToken(), window.getRefreshToken())
    if (window.getAccessToken() == "no token") {
      $('#login-dialog').modal('show');
      return;
    } else {
      window.paiaAPI("GET", "auth/token/verify", null, false, (res) => {
        return;
        }, (jqXHR, exception) => {
          if (jqXHR.status == 401) {
            // Refresh
            window.paiaAPI("POST", "auth/token/refresh", null, false, {
                refresh: window.getRefreshToken()
              }, (res) => {
                window.setToken(res.access, window.getRefreshToken());
              }, (jqXHR, exception) => {
                window.clearToken();
                $('#state-content').html("登入逾期，請重新登入");
                $('#login-dialog').modal('show');
              }
            );
          } else {
            window.clearToken();
            $('#state-content').html("登入逾期，請重新登入");
            $('#login-dialog').modal('show');
          }
        }
      );
    };
  };
  function login() {
    var email = $('#email').val();
    var password = $('#password').val();
    var data = {
      "type": "general",
      "account": {
        "username": email,
        "password": password
      }
    };
    window.paiaAPI("POST", "auth/token", data, false, (res) => {
        window.setToken(res.access, res.refresh);
        $('#state-content').html('登入成功');
        $('#login-dialog').modal('hide');
      }, (jqXHR, exception) => {
        var msg = '';
        if (jqXHR.status === 0) {
            msg = '連線錯誤，請確認網路';
        } else if (jqXHR.status == 401) {
            msg = '密碼驗證錯誤 [401]';
        } else if (exception === 'abort') {
            msg = 'Ajax request aborted.';
        } else {
            msg = 'Uncaught Error.\n' + jqXHR.responseText;
        }
        $('#state-content').html(msg);
      }
    );
  }
  function google_login() {
    $('#state-content').html('請於瀏覽器登入，成功後會自動返回');
    try {
      myApiOauth.openAuthWindowAndGetTokens()
        .then(token => {
          window.setToken(token);
          var oauth2 = window.getOauth2();
          oauth2.userinfo.get(
            function(err, res) {
              if (err) {
                $('#state-content').html('登入失敗，請確認網路連線後重新登入');
                console.log(err);
              } else {
                $('#state-content').html('登入成功');
                $('#login-dialog').modal('hide');
              }
          });
        });
    } catch(e) {
      console.log(e);
    }
  };
  function update_game_list() {
    $('#game_list').empty();
    var gameListDir = path.join(__dirname, 'MLGame', 'games').replace('app.asar', 'app.asar.unpacked');
    fs.readdirSync(gameListDir, { withFileTypes: true }).forEach(dirent => {
      if (dirent.isDirectory()) {
        var gameDir = path.join(gameListDir, dirent.name);
        var configPath = path.join(gameDir, 'game_config.json');
        if (fs.existsSync(configPath)) {
          var config = JSON.parse(window.readFile(configPath));
          var logoPath = (config.logo !== undefined)? path.join(gameDir, config.logo[0]) : "media/paia-logo.png";
          var gameName = (config.game_name !== undefined)? config.game_name : dirent.name;
          var description = (config.description !== undefined)? config.description : "";
          var url = (config.url !== undefined)? config.url : "None";
          var version = (config.version !== undefined)? config.version : "unknown version";
          var $tags = $(`<select class="float-right mr-2 mt-1" id="${dirent.name}-tags"></select>`);
          var downloadStyle = "display: none";
          if (url.indexOf("github.com") != -1) {
            downloadStyle = "";
            var data = url.substring(url.indexOf("github.com") + 11).split('/');
            var owner = data[0];
            var repo = data[1];
            window.githubAPI("GET", `repos/${owner}/${repo}/tags`, null, false, (res) => {
              res.forEach((tag) => {
                $tags.append(`<option value="${tag.name}">${tag.name}</option>`);
              });
            }, (jqXHR, exception) => {
              var msg = '';
              if (jqXHR.status === 0) {
                  msg = '連線錯誤，請確認網路';
              } else if (exception === 'abort') {
                  msg = 'Ajax request aborted.';
              } else {
                  msg = 'Uncaught Error.\n' + jqXHR.responseText;
              }
              console.log(msg);
            });
          } else {
            $tags.css("display", "none");
          }
          $('#game_list').append(
            `<div class="card m-3 mx-auto">
              <div class="row g-0">
                <div class="col-md-4">
                  <img src="${logoPath}" alt="...">
                </div>
                <div class="col-md-8">
                  <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted float-right"><span class="verison" game="${dirent.name}">${config.version}</span></h6>
                    <h3 class="card-title">${gameName}</h3>
                    <p class="card-text" style="min-height: 100px">${description}</p>
                    <a href="code.html?game=${dirent.name}" class="btn btn-primary">積木</a>
                    <a href="python.html?game=${dirent.name}" class="btn btn-primary">Python</a>
                    <a onclick="git_download('${dirent.name}', this)" class="btn btn-primary float-right" style="${downloadStyle}"><i class="bi bi-download"></i> 下載 / 更新</a>
                    ${$tags[0].outerHTML}
                  </div>
                </div>
              </div>
            </div>`);
        }
      }
    });
  };
  function update_version_name() {
    Array.from(document.getElementsByClassName('verison')).forEach(e => {
      var fs = require('fs');
      var config_path = path.join(__dirname, 'MLGame', 'games', e.getAttribute('game'), 'game_config.json');
      if (fs.existsSync(config_path)) {
        var config = JSON.parse(window.readFile(config_path));
        e.innerHTML = config['game_name'] + '-' + config['version'];
        if (e.classList.contains('text-danger')) {
          e.classList.remove("text-danger");
        }
        e.classList.add("text-muted");
      } else {
        e.innerHTML = 'Not Found';
        if (e.classList.contains('text-muted')) {
          e.classList.remove("text-muted");
        }
        e.classList.add("text-danger");
        document.querySelectorAll('a.'+ e.getAttribute('game')).forEach(btn => {
          btn.classList.add("disabled");
        });
      }
    });
  };
  function git_download(game, button) {
    var path = require('path');
    var fs = require('fs');
    var gameDir = path.join(__dirname, 'MLGame', 'games', game).replace('app.asar', 'app.asar.unpacked');;
    var config = JSON.parse(window.readFile(path.join(gameDir, 'game_config.json')));
    var url = (config.url !== undefined)? config.url : "None";
    var version = $(`#${game}-tags`).val();
    var data = url.substring(url.indexOf("github.com") + 11).split('/');
    var owner = data[0];
    var repo = data[1];
    if (window.confirm('下載後會覆蓋此遊戲資料夾下的所有檔案，確定執行？')) {
      button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 下載 / 更新';
      document.querySelectorAll('a.btn').forEach(e => {
        e.classList.add("disabled");
      });
      var download = require('download-git-repo');
      download(`direct:https://github.com/${owner}/${repo}/archive/refs/tags/${version}.zip`, gameDir, function (err) {
        button.innerHTML = '<i class="bi bi-download"></i> 下載 / 更新';
        document.querySelectorAll('a.btn').forEach(e => {
          e.classList.remove("disabled");
        });
        if (err) {
          window.alert(err);
        } else {
          update_version_name();
          var config = JSON.parse(window.readFile(path.join(gameDir, 'game_config.json')));
          window.alert(config['game_name'] + '-' + config['version'] + ' 下載成功');
        }
      });
    };
  };
  document.title += ` ${app.getVersion()}`;
  update_game_list();
  update_version_name();
  // token_login();
</script>